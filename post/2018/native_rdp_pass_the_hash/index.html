<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>Passing the hash with native RDP client (mstsc.exe) - edermi's Blog</title><meta name=description content="TL;DR: If the remote server allows Restricted Admin login, it is possible to login via RDP by passing the hash using the native Windows RDP client mstsc.exe. (You'll need mimikatz or something else to inject the hash into the process)
On engagements it is usually only a matter of time to get your hands on NTLM hashes. These can usually be directly used to authenticate against other services / machines and enable lateral movement."><meta name=author content="Michael Eder"><script type=application/ld+json>{"@context":"http://schema.org","@type":"WebSite","name":"edermi\x27s Blog","url":"https:\/\/michael-eder.net"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Organization","name":"","url":"https:\/\/michael-eder.net"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"https:\/\/michael-eder.net","name":"home"}},{"@type":"ListItem","position":3,"item":{"@id":"https:\/\/michael-eder.net\/post\/2018\/native_rdp_pass_the_hash\/","name":"Passing the hash with native r d p client (mstsc.exe)"}}]}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Article","author":{"name":"Michael Eder"},"headline":"Passing the hash with native RDP client (mstsc.exe)","description":"TL;DR: If the remote server allows Restricted Admin login, it is possible to login via RDP by passing the hash using the native Windows RDP client mstsc.exe. (You\x27ll need mimikatz or something else to inject the hash into the process)\nOn engagements it is usually only a matter of time to get your hands on NTLM hashes. These can usually be directly used to authenticate against other services \/ machines and enable lateral movement.","inLanguage":"en","wordCount":389,"datePublished":"2018-05-06T00:00:00","dateModified":"2018-05-06T00:00:00","image":"https:\/\/michael-eder.net","keywords":["RDP, mimikatz, pass the hash, pth"],"mainEntityOfPage":"https:\/\/michael-eder.net\/post\/2018\/native_rdp_pass_the_hash\/","publisher":{"@type":"Organization","name":"https:\/\/michael-eder.net","logo":{"@type":"ImageObject","url":"https:\/\/michael-eder.net","height":60,"width":60}}}</script><meta property="og:title" content="Passing the hash with native RDP client (mstsc.exe)"><meta property="og:description" content="TL;DR: If the remote server allows Restricted Admin login, it is possible to login via RDP by passing the hash using the native Windows RDP client mstsc.exe. (You'll need mimikatz or something else to inject the hash into the process)
On engagements it is usually only a matter of time to get your hands on NTLM hashes. These can usually be directly used to authenticate against other services / machines and enable lateral movement."><meta property="og:url" content="https://michael-eder.net/post/2018/native_rdp_pass_the_hash/"><meta property="og:type" content="website"><meta property="og:site_name" content="edermi's Blog"><meta name=twitter:title content="Passing the hash with native RDP client (mstsc.exe)"><meta name=twitter:description content="TL;DR: If the remote server allows Restricted Admin login, it is possible to login via RDP by passing the hash using the native Windows RDP client mstsc.exe. (You'll need mimikatz or something else to â€¦"><meta name=twitter:card content="summary"><meta name=twitter:site content="@michael_eder_"><meta name=twitter:creator content="@michael_eder_"><meta name=generator content="Hugo 0.62.2"><link rel=alternate href=https://michael-eder.net/index.xml type=application/rss+xml title="edermi's Blog"><link rel=stylesheet href=https://michael-eder.net/css/katex.min.css><link rel=stylesheet href=https://michael-eder.net/fontawesome/css/all.css><link rel=stylesheet href=https://michael-eder.net/css/bootstrap.min.css><link rel=stylesheet href=https://michael-eder.net/css/main.css><link rel=stylesheet href=https://michael-eder.net/css/fonts.css><link rel=stylesheet href=https://michael-eder.net/css/syntax.css><link rel=stylesheet href=https://michael-eder.net/css/codeblock.css><link rel=stylesheet href=https://michael-eder.net/css/photoswipe.min.css><link rel=stylesheet href=https://michael-eder.net/css/photoswipe.default-skin.min.css></head><body><nav class="navbar navbar-default navbar-fixed-top navbar-custom"><div class=container-fluid><div class=navbar-header><button type=button class=navbar-toggle data-toggle=collapse data-target=#main-navbar>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span><span class=icon-bar></span><span class=icon-bar></span></button>
<a class=navbar-brand href=https://michael-eder.net>edermi's Blog</a></div><div class="collapse navbar-collapse" id=main-navbar><ul class="nav navbar-nav navbar-right"><li><a title=About href=/about/>About</a></li><li><a title=Turingcomplete href=/turingcomplete/>Turingcomplete</a></li></ul></div></div></nav><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><header class=header-section><div class="intro-header no-img"><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=post-heading><h1>Passing the hash with native RDP client (mstsc.exe)</h1><span class=post-meta><i class="fas fa-calendar"></i>&nbsp;Posted on 2018-05-06
&nbsp;(Last modified on 2019-11-01)
&nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;2&nbsp;minutes
&nbsp;|&nbsp;<i class="fas fa-book"></i>&nbsp;389&nbsp;words</span></div></div></div></div></div></header><div class=container role=main><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><article role=main class=blog-post><p><em><strong>TL;DR:</strong> If the remote server allows Restricted Admin login, it is possible to login via RDP by passing the hash using the native Windows RDP client <code>mstsc.exe</code>. (You'll need mimikatz or something else to inject the hash into the process)</em></p><p>On engagements it is usually only a matter of time to get your hands on NTLM hashes.
These can usually be directly used to authenticate against other services / machines and enable lateral movement.
Powershell / PSExec, SMB and WMI are usual targets to pass the hash to, but it is also possible to use it to establish a RDP session on a remote host.
Searching the Internet on how to do this unfortunately always leads to <a href=https://www.kali.org/penetration-testing/passing-hash-remote-desktop/>using xfreerdp</a>, but I wasn't able to find anything on the Internet regarding how to do this directly using the provided RDP client <code>mstsc.exe</code>, so I had to find out on my own.</p><p><img src=/img/shia.gif alt="Don't let your dreams be dreams"></p><h1 id=how-does-it-work>How does it work?</h1><p>Interestingly, it was quite easy to find out, so here is how to do it with <code>mimikatz</code> (you'll need local admin):</p><pre><code>sekurlsa::pth /user:&lt;user name&gt; /domain:&lt;domain name&gt; /ntlm:&lt;the user's ntlm hash&gt; /run:&quot;mstsc.exe /restrictedadmin&quot;
</code></pre><p>This will open a new RDP window. If it still shows the user you are currently logged on with, just ignore it - everything will just work ;-)</p><p>Enter the domain name / IP of the target server and if the target server allows <a href=https://blogs.technet.microsoft.com/kfalde/2013/08/14/restricted-admin-mode-for-rdp-in-windows-8-1-2012-r2/>Restricted Admin Mode</a>, you will be logged in, otherwise the server will tell you that you are not allowed to log in.</p><h1 id=why-does-it-work>Why does it work?</h1><p>RDP Restricted Admin Mode builds upon Kerberos. Taking a look at the network traffic, one can see that the RDP client requests a ticket on behalf of the impersonated user which is no problem since the hash is all we need to authenticate against Kerberos.</p><h1 id=restricted-admin-mode-is-disabled-what-can-i-do>Restricted Admin Mode is disabled, what can I do?</h1><p>A <a href=https://social.technet.microsoft.com/wiki/contents/articles/32905.remote-desktop-services-enable-restricted-admin-mode.aspx>registry key</a> controls if a server accepts Restricted Admin sessions. If you have the NTLM hash of a user that has privileges to set registry keys, you can use for example Powershell to enable it and log in via RDP afterwards:</p><div class=highlight><pre class=chroma><code class=language-Powershell data-lang=Powershell><span class=n>mimikatz</span><span class=p>.</span><span class=n>exe</span> <span class=s2>&#34;</span><span class=s2>sekurlsa::pth /user:&lt;user name&gt; /domain:&lt;domain name&gt; /ntlm:&lt;the user&#39;s ntlm hash&gt; /run:powershell.exe</span><span class=s2>&#34;</span>
</code></pre></div><p>A new Powershell window will pop up:</p><div class=highlight><pre class=chroma><code class=language-Powershell data-lang=Powershell><span class=nb>Enter-PSSession</span> <span class=n>-Computer</span> <span class=p>&lt;</span><span class=n>Target</span><span class=p>&gt;</span>
<span class=nb>New-ItemProperty</span> <span class=n>-Path</span> <span class=s2>&#34;</span><span class=s2>HKLM:\System\CurrentControlSet\Control\Lsa</span><span class=s2>&#34;</span> <span class=n>-Name</span> <span class=s2>&#34;</span><span class=s2>DisableRestrictedAdmin</span><span class=s2>&#34;</span> <span class=n>-Value</span> <span class=s2>&#34;</span><span class=s2>0</span><span class=s2>&#34;</span> <span class=n>-PropertyType</span> <span class=n>DWORD</span> <span class=n>-Force</span>
</code></pre></div><p>Now, your RDP should work fine.</p><p><img src=/img/young_luke.gif alt="Young Luke Skywalker It's working gif"></p><div class=blog-tags><a href=https://michael-eder.net/tags/rdp/>RDP</a>&nbsp;
<a href=https://michael-eder.net/tags/mimikatz/>mimikatz</a>&nbsp;
<a href=https://michael-eder.net/tags/pass-the-hash/>pass the hash</a>&nbsp;
<a href=https://michael-eder.net/tags/pth/>pth</a>&nbsp;</div></article><ul class="pager blog-pager"><li class=previous><a href=https://michael-eder.net/post/2017/praesentieren_mit_markdown/ data-toggle=tooltip data-placement=top title="PrÃ¤sentationen mit Markdown (oder was auch immer)">&larr; Previous Post</a></li></ul></div></div></div><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center footer-links"><li><a href=mailto:spam-blog@michael-eder.net title="Email me"><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i><i class="fas fa-envelope fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://github.com/edermi title=GitHub><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i><i class="fab fa-github fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://twitter.com/michael_eder_ title=Twitter><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i><i class="fab fa-twitter fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://linkedin.com/in/michael-eder-34b923120 title=LinkedIn><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i><i class="fab fa-linkedin fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://www.xing.com/profile/Michael_Eder65 title=Xing><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i><i class="fab fa-xing fa-stack-1x fa-inverse"></i></span></a></li><li><a href title=RSS><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i><i class="fas fa-rss fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="credits copyright text-muted">Michael Eder
&nbsp;&bull;&nbsp;&copy;
2019
&nbsp;&bull;&nbsp;
<a href=https://michael-eder.net>edermi's Blog</a></p><p class="credits theme-by text-muted"><a href=https://gohugo.io>Hugo v0.62.2</a> powered &nbsp;&bull;&nbsp; Theme <a href=https://github.com/halogenica/beautifulhugo>Beautiful Hugo</a> adapted from <a href=https://deanattali.com/beautiful-jekyll/>Beautiful Jekyll</a>
&nbsp;&bull;&nbsp;[<a href=https://github.com/edermi/edermi.github.io/tree/c8faa70e1f878c4b3500a45df70952e622c90008>c8faa70e</a>]</p></div></div></div></footer><script src=https://michael-eder.net/js/katex.min.js></script><script src=https://michael-eder.net/js/auto-render.min.js></script><script src=https://michael-eder.net/js/jquery.min.js></script><script src=https://michael-eder.net/js/bootstrap.min.js></script><script src=https://michael-eder.net/js/main.js></script><script>renderMathInElement(document.body);</script><script src=https://michael-eder.net/js/photoswipe.min.js></script><script src=https://michael-eder.net/js/photoswipe-ui-default.min.js></script><script src=https://michael-eder.net/js/load-photoswipe.js></script></body></html>